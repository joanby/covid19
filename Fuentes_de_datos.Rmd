---
title: 'Fuentes: Datos oficiales  COVID19 España'
author: "Ricardo Alberich, Juan Gabriel Gomila y Arnau Mir"
date: "17/4/2020"
output:
  html_document:
    df_print: paged
    toc: yes
  pdf_document:
    number_sections: yes
    toc: yes
  word_document:
    toc: yes
linkcolor: red
header-includes: \renewcommand{\contentsname}{Contenidos}
citecolor: blue
toccolor: blue
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE)

library(tidyverse)
```





# Datos oficiales del Ministerio de Sanidad de España


Ponemos aquí distintos enlaces a los dartos  y estadísticas  oficiales de Ministerio de Sanidad de España

* [ALERTAS EN SALUD PÚBLICA DE ACTUALIDAD](https://www.mscbs.gob.es/profesionales/saludPublica/ccayes/alertasActual/alertActu.htm)

* [Situación Actual](https://www.mscbs.gob.es/profesionales/saludPublica/ccayes/alertasActual/nCov-China/home.htm)

Desde esta última  página podemos acceder a:

* [Informe de situación actual](https://covid19.isciii.es/)

* [Datos causas de muerte MoMo](https://www.isciii.es/QueHacemos/Servicios/VigilanciaSaludPublicaRENAVE/EnfermedadesTransmisibles/MoMo/Paginas/Informes-MoMo-2020.aspx)





##  Recopilación de los datos oficiales


 La web [Datadista](https://datadista.com/) ha creado  un github con los datos oficiales recopilados y con muchos datos más.
 
 Podéis clonar todo  el repositorio (contiene muchos más datos)  o  solo los datos del COVID19 desde
 
 [Datadista github COVID19](https://github.com/datadista)
 
 
 
## Un primer ejemplo: carga de datos desde dos fuentes 


En este primer ejemplo cargamos hemos descargado  de Datadista`ccaa_camas_uci_2017.csv` que contiene datos de 2017 de las camas de UCI por Comunidad Autónoma, tanto 


```{r}
ccaa_camas=read_csv("data/COVID_19_Datadista/COVID19/ccaa_camas_uci_2017.csv")
```

```{r}
glimpse(ccaa_camas)
```

```{r}
knitr::kable(ccaa_camas)
```


Ahora queremos el porcentaje de camas UIC por población en España y queremos que este añadido sea de producción propia y con datos oficiales en este caso acudiremos al [Instituto Nacional de Estadística de España (INE)](ine.es). 

Desde aquí buscaremos [Población por comunidades y ciudades autónomas y sexo](https://www.ine.es/jaxiT3/Tabla.htm?t=2853).  y nos bajaremos los datos que deseemos ( los  guardamos en DatosINE)

```{r}
poblacion_CCAA=read_tsv("data/DataINE_España/Poblacion_CCAA_2017_2019_2853.csv")
glimpse(poblacion_CCAA)
knitr::kable(poblacion_CCAA)
poblacion_CCAA_2=poblacion_CCAA %>% tidyr::spread(Periodo, Total)
glimpse(poblacion_CCAA_2)
```


```{r}
poblacion_CCAA_2=poblacion_CCAA %>% tidyr::spread(Periodo, Total)
glimpse(poblacion_CCAA_2)
knitr::kable(poblacion_CCAA_2)
```


### Las funciones `spread`  y `gather`


Probaremos estas funciones con el los fichero de datos de altas


#### El fichero de altas  por fecha y comunidad autónoma 


Fichero largo `ccaa_covid19_altas_long.csv` es una tabla de   4  columnas 

* `fecha`  :  La fecha de la observación tomada  de la clase `date`
* `cod_ine`:  Es el código de comunidad autónoma del [Instituto  Nacional de Estadísitica](https://www.ine.es/daco/daco42/codmun/cod_ccaa.htm)
* `CCAA`   :  es el nombre de la comunidad autónoma.
* `total`  :  La observación para `fecha` del número  de altas de esa `CCAA`. 

```{r}
ccaa_altas_long=read_csv("data/COVID_19_Datadista/COVID19/ccaa_covid19_altas_long.csv")
glimpse(ccaa_altas_long)
knitr::kable(ccaa_altas_long)
```


Estos datos los podemos transformar en una tabla con la función `spread`del la librería `tidyr`


```{r}
aux1=ccaa_altas_long %>% tidyr::spread(fecha,total)
knitr::kable(aux1)
```


### Los datos de altas por día y por  comunidad autónoma


Fichero `ccaa_covid19_altas.csv` es un fichero  que puede ser procesado desde el fichero `ccaa_covid19_altas_long.csv`


* La variable  `cod_ine` es el código de comunidad autónoma del [Instituto  Nacional de Estadística](https://www.ine.es/daco/daco42/codmun/cod_ccaa.htm).
* La variable  `CCAA`  es el nombre de la comunidad autónoma.
* El resto de columnas de observación en el tiempo de  la altas de enfermos por coronavirus.


```{r}
ccaa_altas=read_csv("data/COVID_19_Datadista/COVID19/ccaa_covid19_altas.csv")
glimpse(ccaa_altas)
knitr::kable(ccaa_altas[1:30,])
```



Podemos recuperar el fichero largo con la función  `gather`



```{r}
aux2=ccaa_altas %>% gather(Time,value=Total,-c(cod_ine,CCAA))
glimpse(aux2)
knitr::kable(aux2)
```


```{r}
aux3=aux2 %>% spread(Time,value=Total)
knitr::kable(aux3)
```



### Casos declarados de  coronavirus por día y por  comunidad autónoma




De la misma forma tenemos los datos  de casos declarados de infección por de coronavirus.

Fichero `ccaa_covid19_casos.csv` es un fichero procesado desde el fichero `ccaa_covid19_casos_long.csv`

* La variable  `cod_ine` es el código de comunidad autónoma del [Instituto  Nacional de Estadística](https://www.ine.es/daco/daco42/codmun/cod_ccaa.htm).
* La variable `CCAA` contine el nombre de la Comunidad Autónoma. 
* El resto de columnas de observación en el tiempo de  los casos de infección por coronavirus.
* En ingles se les llama  a estos  dos formatos de tablas **wide**  (ancho)  y **long** (largo).

```{r}
ccaa_casos=read_csv("data/COVID_19_Datadista/COVID19/ccaa_covid19_casos.csv")
glimpse(ccaa_casos)
knitr::kable(ccaa_casos[1:30,])
```



Podemos recuperar el fichero largo con la función  `gather`



```{r}
aux2=ccaa_casos %>% gather(Time,value=Total,-c(cod_ine,CCAA))
glimpse(aux2)
knitr::kable(aux2)
```


```{r}
aux3=aux2 %>% spread(Time,value=Total)
knitr::kable(aux3)
```



## Nuestro modelo de datos


Definamos  nuestro modelo de datos Para ello separemos los ficheros de datos en  dos grupos


##  Metadatos


Son datos relativos a las unidades en las que se miden las variables. Las unidades pueden ser: continentes, países, regiones. Las regiones reciben distintas denominaciones según la organización de cada país: departamentos, estados, comunidades autónomas, **landers** , provincias, etc.


Algunos de los ficheros correspondientes a metadatos  son :

* `alojamientos_turisticos_boe_2020_4194.csv`
* `ccaa_camas_uci_2017.csv`
* `ccaa_covid19_mascarillas.csv`
* `municipios_distritos_madrid_casos.csv`
* `nacional_covid19_rango_edad.csv`
* `puntos_restauracion_comida_para_llevar.csv`


## Datos sobre la epidemia

Los datos epidemiológicos son los que e contabilidad datos sobre la pandemia en cada unidad de medida. Como ya hemos explicado están en la versión **wide**  la **long**



* Datos de *casos* de pacientes de coronavirus
  + `ccaa_covid19_casos.csv`; `ccaa_covid19_casos_log.csv`
* Datos de *altas* de pacientes de coronavirus
  + `ccaa_covid19_altas.csv`; `ccaa_covid19_altas_log.csv`
* Datos de *fallecidos* de pacientes de coronavirus
  + `ccaa_covid19_fallecidos.csv`; `ccaa_covid19_fallecidos_log.csv`
* Datos de pacientes *hospitalizados*  de pacientes de coronavirus
  + `ccaa_covid19_hospitalizados.csv`; `ccaa_covid19_hospitalizados_log.csv`
* Datos de pacientes en *UCI*  de pacientes de coronavirus
  + `ccaa_covid19_uci.csv`; `ccaa_covid19_uci_log.csv`


## Nuestro modelo de datos 


Vamos a construir una tabla  de tipo "log" con todos los datos. Para ello apilaremos las tablas long añadiendo la categoría que mide la variable total: casos, ingresos, fallecimientos, uci.

Empecemos con algunas variables auxiliares



```{r}
tipos=c("casos","hospitalizados","fallecidos","uci")
prefijo="data/COVID_19_Datadista/COVID19/ccaa_covid19_"
sufijo="_long.csv"
arreglo<- function(tipo,prefijo="data/COVID_19_Datadista/COVID19/ccaa_covid19_",sufijo="_long.csv"){
aux=read_csv(paste0(prefijo,tipo,sufijo))
aux$tipo=tipo
return(aux)
}

datos_COVID19_long=bind_rows(lapply(tipos,FUN=arreglo))

```

## Añadir metadatos a nuestro modelo de datos


Vamos a añadir las poblaciones de cada comunidad Autónoma y  su número de camas  de cuidados intensivos (uci).

```{r}
camas_uci=read_csv("data/COVID_19_Datadista/COVID19/ccaa_camas_uci_2017.csv")
camas_uci %>% rename(Públicos_UCI=Públicos,Privaos_UCI=Privados,Total_UCI=Total)
knitr::kable(camas_uci)
```


Ahora leeremos la población por CCAA. Construimos la tabla a lo ancho, seleccionamos  el año  y eliminamos los totales


```{r}
poblacion_CCAA=read_tsv("data/DataINE_España/Poblacion_CCAA_2017_2019_2853.csv",locale = locale(grouping_mark = "."))
poblacion_CCAA= poblacion_CCAA %>% 
  filter(`Comunidades y Ciudades Autónomas`!="Total",Sexo=="Total",Periodo==2019) %>%
  transmute(cod_ine=str_sub(`Comunidades y Ciudades Autónomas`,1,2),
    Pob_CCAA_2019=Total,CCAA=`Comunidades y Ciudades Autónomas`)
glimpse(poblacion_CCAA)
knitr::kable(poblacion_CCAA)
```


### Añadimos los metadatos

Podemos construir una tibble que contega toda la información utilizando funciones  tipo "inner_join

```{r}
metadatos_CCAA=  poblacion_CCAA %>% select(-CCAA) %>%
  inner_join(camas_uci,by="cod_ine") %>% rename(UCIS_Públicos=Públicos,UCIS_Privados=Privados, UCI_Total=Total)

datos_COVID19_con_metadatos_long= datos_COVID19_long %>% inner_join(metadatos_CCAA %>% select(-CCAA))


```



## Guardamos los datos 

Guardaremos los datos como objetos y como cvs

```{r}
save(datos_COVID19_long,
     file="data/Modelo_Datos/datos_COVID19_long_long.Robj")
save(metadatos_CCAA,
     file="data/Modelo_Datos/metadatos_CCAA.Robj")
save(datos_COVID19_con_metadatos_long,
     file="data/Modelo_Datos/datos_COVID19_con_metadatos_long.Robj")
  
  
write_csv(datos_COVID19_long,
          path="data/Modelo_Datos/datos_COVID19_long_long.csv")
write_csv(metadatos_CCAA,
          path="data/Modelo_Datos/metadatos_CCAA.csv")
write_csv(datos_COVID19_con_metadatos_long,
          path="data/Modelo_Datos/datos_COVID19_con_metadatos_long.csv")

```

